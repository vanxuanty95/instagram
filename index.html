<!DOCTYPE html>
<html>

<head>
    <script async="" src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <style>
        #imageGenerated {
            display: none;
        }

        img {
            width: 200px;
        }

        #generateProgress {
            width: 100%;
            background-color: grey;
        }

        #progressBar {
            width: 1%;
            height: 30px;
            background-color: green;
        }
    </style>
</head>

<body>

    <form id="formGenerateImage" action="" title="" method="post">
        <div>
            <label class="title">username</label>
            <input type="text" id="username" name="username">
        </div>
        <div>
            <input type="submit" id="formGenerateImageSubmitButton" name="formGenerateImageSubmitButton" value="Submit">
        </div>
    </form>
    <div id="generateProgress">
        <div id="progressBar"></div>
    </div>

    <button id="downloadBtn" disabled>
        Download
    </button>
    <a id="temp" style="display: none;"></a>

    <div id="capture">
        <h4 id="author_name"></h4>
        <h4 id="post_count"></h4>
        <h4 id="follower_count"></h4>
        <h4 id="following_count"></h4>
        <img id="profile_image" class="media" src="">
        <div id="post_images"></div>
    </div>

    <script>
        $(document).ready(function () {
            var maximumImages = 7;

            $("#formGenerateImage").submit(function (event) {
                event.preventDefault();
                resetVariable();
                let username = $('#username').val().trim();
                if (username == "") {
                    alert("empty");
                    return;
                }
                getInfomation(username);
            });

            $("#downloadBtn").click(function (event) {
                var can = document.getElementById("imageGenerated");
                image = can.toDataURL("image/png").replace("image/png", "image/octet-stream");
                var link = document.getElementById('temp');
                link.download = "picture.png";
                can.toBlob(function (blob) {
                    link.href = URL.createObjectURL(blob);
                    link.click();
                })
            });

            function resetVariable() {
                maximumImages = 7;
                $("#downloadBtn").attr("disabled", true);
                $('#post_images').empty();
                $('#media_post').remove();
            }

            function getInfomation(username) {
                $.ajax({
                    type: 'GET',
                    url: 'https://www.instagram.com/' + username + "/?__a=1",
                    dataType: 'json',
                    success: function (data) {
                        $('#author_name').text(data.graphql.user.full_name);
                        $('#profile_image').attr("src", data.graphql.user.profile_pic_url_hd);
                        $('#post_count').text(data.graphql.user.edge_owner_to_timeline_media.count);
                        $('#follower_count').text(data.graphql.user.edge_followed_by.count);
                        $('#following_count').text(data.graphql.user.edge_follow.count);
                        setMostRecentPhotos(data.graphql.user.edge_owner_to_timeline_media.edges);
                        convertToImage();
                    },
                    error: function () {
                        alert("Page not found");
                    }
                });
            }

            function setMostRecentPhotos(edgesArray) {
                let edgesIdx;
                let maximumLoopArray;
                if (edgesArray.length === 0) {
                    maximumImages = 0;
                    return
                }
                if (edgesArray.length < maximumImages) {
                    maximumImages = edgesArray.length;
                }
                maximumLoopArray = maximumImages - 1;
                for (edgesIdx = 0; edgesIdx < maximumLoopArray; ++edgesIdx) {
                    let newImgElemnet = "<img id=\"" + edgesIdx + "_post_image\" class=\"media\" src=\"" + edgesArray[edgesIdx].node.display_url + "\">"
                    $('#post_images').append(newImgElemnet);
                }
                let newImgElemnet = "<img id=\"media_post\" class=\"media\" src=\"" + edgesArray[maximumLoopArray].node.display_url + "\">"
                $('#capture').append(newImgElemnet);
            }

            function getImage(url) {
                arrayURLStr = url.split("/");
                media_id = arrayURLStr[4];
                imageSrc = "https://instagram.com/p/" + media_id + "/media/?size=l";
                $('#media_post').attr("src", imageSrc);
            }

            function convertToImage() {
                let totalFinish = 0;
                let isRun = 0;

                if (isRun == 0) {
                    isRun = 1;
                    var elem = document.getElementById("progressBar");
                    var width = 1;
                }

                $('img.media').on('load', function () {
                    totalFinish++;
                    if (totalFinish == maximumImages + 1) {
                        html2canvas(document.querySelector("#capture"), { allowTaint: true, useCORS: true }).then(function (canvas) {
                            canvas.id = "imageGenerated";
                            document.body.appendChild(canvas)
                            frame(100);
                            $("#downloadBtn").attr("disabled", false);
                        });
                    }
                    frame(totalFinish);
                });

                function frame(full) {
                    if (width >= 100) {
                        isRun = 0;
                    } else {
                        if (full === 100) {
                            width = full - 1;
                        }
                        width = full / (maximumImages + 1) * 100;
                        elem.style.width = width + "%";
                    }
                }
            }
        });
    </script>

</body>

</html>